<!DOCTYPE html>
<html>
  <head>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <script src="https://www.gstatic.com/firebasejs/4.5.2/firebase.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/geocodezip/geoxml3/master/polys/geoxml3.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/geocodezip/geoxml3/master/ProjectedOverlay.js"></script>
  </head>
  <body onmousedown="mouseDown(event)" onmouseup="mouseUp(event)">
    <div id="map"></div>
    <script>
      var map;
      var featureOpts = [
	  {
	    "featureType": "administrative.country",
	    "elementType": "geometry.stroke",
	    "stylers": [
	      {
	        "visibility": "off"
	      }
	    ]
	  },
	  {
	    "featureType": "administrative.country",
	    "elementType": "labels",
	    "stylers": [
	      {
	        "visibility": "off"
	      }
	    ]
	  },
	  {
	    "featureType": "administrative.province",
	    "elementType": "geometry.stroke",
	    "stylers": [
	      {
	        "visibility": "off"
	      }
	    ]
	  },
	  {
	    "featureType": "administrative.province",
	    "elementType": "labels.text",
	    "stylers": [
	      {
	        "visibility": "off"
	      }
	    ]
	  }
	];
	  var MY_MAPTYPE_ID = "Shadowrun";
	  var mouseDown = false;
	  var tempLat = 0;
	  var tempLng = 0;
	  var minTravel = 1;
	  var curLine = null;
	  var myMarkers = [];
	  var myLines = [];
      var firebase = null;

	  function distance(x1, x2, y1, y2) {
	  	var a = x2 - x1;
	  	var b = y2 - y1;
	  	return Math.sqrt(a * a + b * b);
	  }

	  function guid() {
		  function s4() {
		    return Math.floor((1 + Math.random()) * 0x10000)
		      .toString(16)
		      .substring(1);
		  }
		  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
		    s4() + '-' + s4() + s4() + s4();
		}

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 30.0444, lng: 31.2357},
          zoom: 3,
          mapTypeControlOptions: {
		    mapTypeIds: [google.maps.MapTypeId.ROADMAP, MY_MAPTYPE_ID]
		  },
		  mapTypeId: MY_MAPTYPE_ID,
		  disableDoubleClickZoom: true,
    		streetViewControl: false,
        });
       	var styledMapOptions = {
		  name: 'Custom Style'
		};

		var customMapType = new google.maps.StyledMapType(featureOpts, styledMapOptions);

		map.mapTypes.set(MY_MAPTYPE_ID, customMapType);

		var ctaLayer = new google.maps.KmlLayer({
          url: "https://google.com/maps/d/kml?mid=1vTTZrcPvgTyuGV9EJjYxoZUDLZw&dummy=" + (new Date()).getTime(),
          map: map
        });

        map.addListener('mousedown', function(e) {
        	mouseDown = true;
        	tempLat = e.latLng.lat();
        	tempLng = e.latLng.lng();
        	curLine = null;
        });

        map.addListener('mouseup', function(e) {
        	mouseDown = false;
        	tempLat = e.latLng.lat();
        	tempLng = e.latLng.lng();
        	if (curLine == null) {
        		firebase.child('markers').push({
        			lat: tempLat,
        			lng: tempLng,
        			id: guid()
        		});
        	} else {
        		firebase.child('lines').push({
        			path: curLine,
        			id: guid()
        		});
        	}
        });

        map.addListener('mousemove', function(e) {
        	if (!mouseDown) {
        		return;
        	}
        	var curLat = e.latLng.lat();
        	var curLng = e.latLng.lng();
        	if (distance(curLat, tempLat, curLng, tempLng) > minTravel) {
        		if (curLine == null) {
        			curLine = [];
        		}
        		curLine.push({lat: curLat, lng: curLng});
        		tempLat = curLat;
        		tempLng = curLng;
        	}
        });

        // firebase = new Firebase("https://shadowrunmap.firebaseio.com");
        var config = {
            apiKey: "AIzaSyCc6Z3xARTskSNQZOC8XmLKXmyUn3gXmjs",
            authDomain: "shadowrunmap.firebaseapp.com",
            databaseURL: "https://shadowrunmap.firebaseio.com",
            projectId: "shadowrunmap",
            storageBucket: "shadowrunmap.appspot.com",
            messagingSenderId: "9558394399"
          };
          firebase.initializeApp(config);
          firebase.auth().onAuthStateChanged(function() {
            var markers = firebase.child('markers');
        	var lines = firebase.child('lines');
        	markers.on('child_added', function(snapshot) {
        		var val = snapshot.val();
        		var marker = new google.maps.Marker({position: new google.maps.LatLng(val.lat, val.lng)});
        		marker.setMap(map);
        		marker.addListener('click', function(e) {
        			snapshot.ref().remove();
        		});
        		myMarkers.push({
        			marker: marker,
        			id: val.id
        		});
        	});
        	markers.on('child_removed', function(snapshot) {
        		var val = snapshot.val();
        		for (var i = 0; i < myMarkers.length; i++) {
        			var marker = myMarkers[i];
        			if (marker.id == val.id) {
        				marker.marker.setMap(null);
        				myMarkers.splice(i, 1);
        				break;
        			}
        		}
        	});
        	lines.on('child_added', function(snapshot) {
        		var val = snapshot.val();
        		var line = new google.maps.Polyline({
        				path: val.path,
        				geodesic: false,
        				strokeColor: '#FF0000',
        				strokeOpacity: 1,
        				strokeWeight: 1
        			});
        		line.setMap(map);
        		line.addListener('click', function(e) {
        			snapshot.ref().remove();
        		});
        		myLines.push({
        			line: line,
        			id: val.id
        		});
        	});
        	lines.on('child_removed', function(snapshot) {
        		var val = snapshot.val();
        		for (var i = 0; i < myLines.length; i++) {
        			var line = myLines[i];
        			if (line.id == val.id) {
        				line.line.setMap(null);
        				myLines.splice(i, 1);
        				break;
        			}
        		}
    		});
        }
          firebase.auth().signInAnonymously();
      }

      function mouseDown(event) {
        console.log(event.button);
      }

      function mouseUp(event) {
        console.log(event.button);
      }

		// var config = {
		//     apiKey: "AIzaSyCc6Z3xARTskSNQZOC8XmLKXmyUn3gXmjs",
		//     authDomain: "shadowrunmap.firebaseapp.com",
		//     databaseURL: "https://shadowrunmap.firebaseio.com",
		//     projectId: "shadowrunmap",
		//     storageBucket: "shadowrunmap.appspot.com",
		//     messagingSenderId: "9558394399"
		//   };
		//   firebase.initializeApp(config);
		//   firebase.auth().onAuthStateChanged(function(user) {
        	
  //       	});
        
		// firebase.auth().signInAnonymously();
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCplpgXDpN4kI1ovfu014LV1xw_bkMGXo8&callback=initMap"
    async defer></script>
  </body>
</html>
